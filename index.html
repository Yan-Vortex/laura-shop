<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Laura Shop's — Catalogue</title>
<style>
/* [Vos styles CSS restent identiques] */
</style>
</head>
<body>
<!-- [Votre HTML reste identique] -->

<script>
/* ----------------------------
   CONFIG & UTILITAIRES
   ---------------------------- */
const CONFIG={whatsapp:'+237694484568', defaultPassword:'Laure1975', shopName:"Laura Shop's"};
const API = {
  base: 'https://api-fugh.onrender.com',
  sections: 'https://api-fugh.onrender.com/sections',
  products: 'https://api-fugh.onrender.com/products'
};
const $=s=>document.querySelector(s), qs=s=>Array.from(document.querySelectorAll(s));
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8);
let LANG='fr';
const TEXT={fr:{order:'Commander sur WhatsApp',admin:'Espace administrateur'},en:{order:'Order on WhatsApp',admin:'Admin Area'}};
const t=k=>TEXT[LANG][k]||k;
const normalizeString=str=>String(str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();

/* ----------------------------
   Server API wrapper
   ---------------------------- */
async function apiGet(url){
  try{
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error('fetch failed');
    return await r.json();
  }catch(e){
    console.error('API error:', e);
    return [];
  }
}

async function apiPost(url, body){
  try{
    const r = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok) throw new Error('post failed');
    return await r.json();
  }catch(e){
    console.error('API error:', e);
    throw e;
  }
}

async function apiPut(url, body){
  try{
    const r = await fetch(url, {method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok) throw new Error('put failed');
    return await r.json();
  }catch(e){
    console.error('API error:', e);
    throw e;
  }
}

async function apiDelete(url){
  try{
    const r = await fetch(url, {method:'DELETE'});
    if(!r.ok) throw new Error('delete failed');
    return true;
  }catch(e){
    console.error('API error:', e);
    return false;
  }
}

/* ----------------------------
   Data layer (server primary)
   ---------------------------- */
async function loadSections(){ return await apiGet(API.sections); }
async function addSection(section){ return await apiPost(API.sections, section); }
async function saveSection(section){ return await apiPut(`${API.sections}/${section.id}`, section); }
async function deleteSectionById(id){ return await apiDelete(`${API.sections}/${id}`); }

async function loadProducts(){ return await apiGet(API.products); }
async function addProduct(product){ return await apiPost(API.products, product); }
async function saveProduct(product){ return await apiPut(`${API.products}/${product.id}`, product); }
async function deleteProductById(id){ return await apiDelete(`${API.products}/${id}`); }

/* ----------------------------
   Admin state & helpers
   ---------------------------- */
function isAdmin(){return sessionStorage.getItem('admin')==='1'}
function setAdmin(v){sessionStorage.setItem('admin',v?'1':'0'); updateAdminUI();}

/* ----------------------------
   Rendering & business logic
   ---------------------------- */
let editingId=null;
let editingSectionId=null;

async function renderSections(){
  const list = $('#sections-list');
  list.innerHTML = '';
  const sections = await loadSections();

  sections.forEach(s=>{
    const li = document.createElement('li');
    li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.marginBottom='4px';
    li.innerHTML = `<span>${s.name}</span>
                    <span>
                      <button class="small btn secondary edit-section" data-id="${s.id}">Edit</button>
                      <button class="small btn secondary del-section" data-id="${s.id}">Suppr</button>
                    </span>`;
    list.appendChild(li);
  });
  qs('.edit-section').forEach(b=>b.onclick=()=>startEditSection(b.dataset.id));
  qs('.del-section').forEach(b=>b.onclick=()=>handleDeleteSection(b.dataset.id));

  await updateSectionSelects(sections);
  buildSectionNav(sections);
  renderSectionFilter();
}

async function updateSectionSelects(sections){
  const sel = $('#section-select');
  sel.innerHTML = '<option value="">-- Choisir une section --</option>';
  sections.forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s.id; opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

async function renderSectionFilter(){
  const sel = $('#section-filter');
  sel.innerHTML = '<option value="">Toutes les sections</option>';
  const sections = await loadSections();
  sections.forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s.id; opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

/* Sections management */
function clearSectionForm(){ editingSectionId=null; $('#section-input').value=''; }
async function addOrUpdateSection(){
  const name = $('#section-input').value.trim();
  if(!name) return alert('Nom de section requis');
  if(editingSectionId){
    try{
      const s = { id: editingSectionId, name };
      await saveSection(s);
    }catch(e){ console.warn(e); alert('Erreur mise à jour section'); }
  } else {
    try{ await addSection({ name }); }catch(e){ console.warn(e); alert('Erreur création section'); }
  }
  clearSectionForm();
  await renderSections();
  await renderProducts();
}
async function startEditSection(id){
  const s = (await loadSections()).find(x=>x.id===id);
  if(!s) return;
  editingSectionId = id;
  $('#section-input').value = s.name;
}
async function handleDeleteSection(id){
  if(!confirm('Supprimer cette section et tous ses articles ?')) return;
  try{ await deleteSectionById(id); }catch(e){ console.warn(e); }
  const products = await loadProducts();
  for(const p of products){
    if(p.sectionId === id){
      try{ await deleteProductById(p.id); }catch(e){ console.warn(e); }
    }
  }
  await renderSections();
  await renderProducts();
}

/* Products - VERSION CORRIGÉE */
function clearForm(){ 
  editingId=null; 
  $('#name-input').value=''; 
  $('#price-input').value=''; 
  $('#desc-input').value=''; 
  $('#file').value=''; 
  $('#preview').innerHTML=''; 
  $('#section-select').value=''; 
}

async function addOrUpdate(){
  const n = $('#name-input').value.trim();
  const pr = parseFloat($('#price-input').value) || 0;
  const d = $('#desc-input').value.trim();
  const secId = $('#section-select').value;
  if(!n) return alert('Nom requis');
  if(!secId) return alert('Section requise');

  const formData = new FormData();
  formData.append('name', n);
  formData.append('price', pr);
  formData.append('description', d);
  formData.append('sectionId', secId);

  const f = $('#file').files[0];
  if(f){
    formData.append('image', f);
  }

  try {
    let res;
    if(editingId){
      res = await fetch(`${API.products}/${editingId}`, {
        method: 'PUT',
        body: formData
      });
    } else {
      res = await fetch(API.products, {
        method: 'POST',
        body: formData
      });
    }
    
    if(!res.ok) throw new Error('Erreur serveur');
    const result = await res.json();
    
  } catch(e){
    console.warn(e);
    alert('Erreur ajout / modification produit');
  }

  clearForm();
  await renderProducts();
}

async function startEdit(id){
  const p = (await loadProducts()).find(x=>x.id===id);
  if(!p) return;
  editingId = id;
  $('#name-input').value = p.name || '';
  $('#price-input').value = p.price || '';
  $('#desc-input').value = p.description || '';
  $('#section-select').value = p.sectionId || '';
  
  // Afficher l'image existante avec l'URL complète
  if(p.image) {
    $('#preview').innerHTML = `<img src='${API.base}${p.image}' style="max-width:100%;max-height:100%">`;
  } else {
    $('#preview').innerHTML = '';
  }
  
  if(window.innerWidth <= 600) $('#admin-panel').scrollIntoView({behavior:'smooth'});
}

async function handleDeleteProduct(id){
  if(!confirm('Supprimer cet article ?')) return;
  try{ await deleteProductById(id); }catch(e){ console.warn(e); }
  await renderProducts();
}

/* WhatsApp helper */
function whatsappUrl(p){
  const base='https://wa.me/'+CONFIG.whatsapp.replace(/\D/g,'');
  const productUrl=`${window.location.origin}${window.location.pathname}#product-${encodeURIComponent(p.name.toLowerCase().replace(/\s+/g,'-'))}`;
  const msg=LANG==='fr'
    ?`Bonjour Mme Laure, je souhaite commander ${p.name} au prix de ${p.price.toLocaleString()} Fcfa.\nVoir le produit ici : ${productUrl}`
    :`Hello, I want to order ${p.name} for ${p.price.toLocaleString()} Fcfa.\nSee the product here: ${productUrl}`;
  return base+'?text='+encodeURIComponent(msg);
}

/* Build section nav */
function buildSectionNav(sections){
  const nav = $('#section-nav');
  nav.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.textContent = 'Toutes';
  allBtn.onclick = ()=>{
    qs('#section-nav button').forEach(b=>b.classList.remove('active'));
    allBtn.classList.add('active');
    $('#section-filter').value = '';
    renderProducts();
  };
  allBtn.classList.add('active');
  nav.appendChild(allBtn);

  sections.forEach(s=>{
    const b = document.createElement('button');
    b.textContent = s.name;
    b.onclick = ()=>{
      qs('#section-nav button').forEach(b=>b.classList.remove('active'));
      b.classList.add('active');
      $('#section-filter').value = s.id;
      renderProducts().then(()=> {
        const el = document.querySelector(`#products-grid [data-section="${s.id}"]`);
        if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
      });
    };
    nav.appendChild(b);
  });
}

/* Render products grouped by section - VERSION CORRIGÉE */
async function renderProducts(){
  const grid = $('#products-grid');
  grid.innerHTML = '';
  let products = await loadProducts();
  const sections = await loadSections();
  const q = normalizeString($('#search').value.trim());
  const sectionFilter = $('#section-filter').value;
  const sortVal = $('#sort').value;

  if(sortVal === 'price-asc') products.sort((a,b)=>a.price - b.price);
  else if(sortVal === 'price-desc') products.sort((a,b)=>b.price - a.price);

  const matchedSectionIds = new Set();
  if(q){
    sections.forEach(s=>{
      if(normalizeString(s.name).includes(q)) matchedSectionIds.add(s.id);
    });
  }

  for(const section of sections){
    if(sectionFilter && section.id !== sectionFilter) continue;
    let sectProducts = products.filter(p => p.sectionId === section.id);

    if(q){
      sectProducts = sectProducts.filter(p => {
        const productText = normalizeString((p.name || '') + ' ' + (p.description || ''));
        return productText.includes(q) || matchedSectionIds.has(section.id);
      });
    }

    if(sectProducts.length === 0) continue;

    const secDiv = document.createElement('div');
    secDiv.setAttribute('data-section', section.id);
    secDiv.innerHTML = `<h3 id="section-${section.id}">${section.name}</h3>`;
    const sectGrid = document.createElement('div'); sectGrid.className = 'grid';

    for(const x of sectProducts){
      const c = document.createElement('article'); c.className = 'card';
      // CORRECTION : Utiliser l'URL complète pour les images
      const imageSrc = x.image ? `${API.base}${x.image}` : '';
      c.innerHTML = `<div class='thumb' data-img='${imageSrc}'>${x.image ? `<img src='${imageSrc}'>` : '<div class="muted">Aucune image</div>'}</div>
      <div class='card-body'>
        <div class='name'>${x.name}</div>
        <div class='desc'>${x.description || ''}</div>
        <div style='display:flex;justify-content:space-between;align-items:center'>
          <div class='price'>${(x.price || 0).toLocaleString()} Fcfa</div>
          <div class='card-actions'>
            <a class='small btn' href='${whatsappUrl(x)}' target='_blank'>${t('order')}</a>
            ${isAdmin() ? `<div class="admin-actions">
              <button class="small btn secondary edit" data-id="${x.id}">Edit</button>
              <button class="small btn secondary del" data-id="${x.id}">Suppr</button>
            </div>` : ''}
          </div>
        </div>
      </div>`;
      sectGrid.appendChild(c);
    }

    secDiv.appendChild(sectGrid);
    grid.appendChild(secDiv);
  }

  qs('.thumb').forEach(t=>t.onclick=()=>{
    const src = t.querySelector('img')?.src;
    if(src){ $('#img-modal img').src = src; $('#img-modal').style.display = 'flex'; }
  });
  $('#close-modal').onclick = ()=>$('#img-modal').style.display = 'none';

  qs('.edit').forEach(b=>b.onclick=()=>startEdit(b.dataset.id));
  qs('.del').forEach(b=>b.onclick=()=>handleDeleteProduct(b.dataset.id));
}

/* ----------------------------
   Admin UI update & events
   ---------------------------- */
function updateAdminUI(){
  const panel = $('#admin-panel');
  if(isAdmin()){
    panel.classList.add('show');
    $('#admin-btn').style.display='none';
  } else {
    panel.classList.remove('show');
    $('#admin-btn').style.display='inline-block';
  }
  renderSections();
  renderProducts();
}

/* ----------------------------
   Event bindings & init
   ---------------------------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  $('#year').textContent = new Date().getFullYear();

  await renderSections();
  await renderProducts();
  updateAdminUI();

  $('#admin-btn').onclick = ()=> {
    const pw = prompt("Réservé à l'administrateur");
    if(pw === CONFIG.defaultPassword) setAdmin(true);
    else alert('Mot de passe incorrect');
  };
  $('#logout').onclick = ()=>{ setAdmin(false); };

  $('#add-btn').onclick = addOrUpdate;
  $('#cancel-edit').onclick = clearForm;
  $('#add-section-btn').onclick = addOrUpdateSection;
  $('#clear-section-btn').onclick = clearSectionForm;
  $('#search').oninput = renderProducts;
  $('#sort').onchange = renderProducts;
  $('#section-filter').onchange = renderProducts;

  let minimized = false;
  $('#admin-toggle').onclick = ()=>{
    const content = $('#admin-content');
    minimized = !minimized;
    content.style.display = minimized ? 'none' : 'block';
    $('#admin-toggle').textContent = minimized ? '+' : '–';
  };

  $('#file').onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>$('#preview').innerHTML = `<img src='${reader.result}'>`;
    reader.readAsDataURL(f);
  };

  $('#lang-fr').onclick = ()=>{ LANG='fr'; renderProducts(); };
  $('#lang-en').onclick = ()=>{ LANG='en'; renderProducts(); };

  if(isAdmin()) updateAdminUI();
});
</script>
</body>
</html>
